<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-ua-compartible" content="IE=edge">
    <meta name="amazon" content="width=device=width, initial-scale=1.0">
    <title>Producto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="css/producto.css" href=" https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
</head>

    <body>
      <header>
        <nav>
        <div class="dflex"><a href="index.html"><img src="img/amazonlogo.png" align="left" class="logo"/><span></span></a>
           
           <nav>
            <div class="item">
               <button class="dflex" type="button"><i> Hola, </p><h5>Elige tu Direccion</h5></button>
            </div>
                </div>
      
                        <div class="searchBox dflex">
                            <div class="box">
                                <div class="dflex">
                                  
                                  <button class="all" type="button"> Todos los Departamentos 
                                     
                                  </button>
                                   <input type="text" id="inputBuscar"><button class="search" onclick="buscar();">Buscar</button>
      
                                          <nav class="registros">
                                            <div class="item" id="usuario_logueado">
                                               <a href="login.html" ><i > Hola, <span id="nombre_logueado"></span> </p><h5> Cuentas y Listas</h5></i></a>
                                               
                                            </div>
                                            <div class="menu_usuario" id="menu_usuario" style="position:absolute; right:260px; top: 55px; background-color: white; z-index: 1000; width: 100px; display: none;">
                                              <ul>
                                                <div id="administracion">
                                                  <li><a href="AdCategoria.html">Administrar Categorias</a></li>
                                                  <li><a href="AdProductos.html">Administrar Productos</a></li>
                                                </div>
                                                
                                                <li><a href="#" onclick='cerrarSesion()'>Cerrar sesion</a></li>
                                              </ul>
                                             </div>
                                            <div class="item">
                                               <a href="pedidos.html"><button class="dflex" type="button"><i> Devoluciones </p><h5> y Pedidos </h5></button></a>
                                                   
                                              </div>
                                          
                                              <div class="item">
                                             <button class="dflex" id="btnCarrito" type="button"><i> Carrito </p><h5> </h5></i></button>
                                             <div id="carrito" class="carrito" style="position:absolute; right:150px; top: 80px; z-index: 1000;">
                                        
                                              <table id="lista-carrito" class="tabla-carrito">
                                                          <thead>
                                                              <tr>
                                                                  <th>Imagen</th>
                                                                  <th>Producto</th>
                                                                  <th>Precio</th>
                                                                  <th>Total</th>
                                                                  
                                                              </tr>
                                                          </thead>
                                                          <tbody id="bodyCarrito">
              
                                                          </tbody>
                                              </table>
                                              <div class="botones-carrito">
                                              <a href="#" id="vaciar-carrito" class="btn btn-danger w-50">Vaciar Carrito</a>
                                              <a href="Tabla2/index.html" id="finalizar-pedido" class="btn btn-success w-50">Finalizar pedido</a>
                                              </div>
                      </div>
                </div>
                                </nav>
                             
      </div>
                </div>
             </div>
        
        </nav>
      </nav>
        <nav class="subnavegation">
          <ul class="submenu" id="submenu">
      
      
      
            <!-- <li> <a href="#"><i class="fa fa-bars">Todo</li></i>
            <li><a href="#"><li>Vender</li>
            <li><a href="#"><li>Lo mas vendido</li>
            <li><a href="#"><li>Amazon basic<i class="fa fa-sort-desc"></i></li>
            <li><a href="#"><li>Prime</li>
            <li><a href="#"><li>Servicio al cliente</li>
            <li><a href="#"><li>Moda</li>
            <li><a href="#"><li>Electronicos</li>
            <li><a href="#"><li>Promociones</li> -->
            
          </ul>
          <ul>
            <li><a href="#">
              <li class="li">30 Dias GRATIS AmazonMusic</li>
            </a>
          </ul>
        </nav>
        </header>
      
      <p class="card-text"><small class="text-muted"></small></p>
    <!-- ===================================== -->
    <!-- NAV -->
    <!-- ===================================== -->
    
    

    <!-- ===================================== -->
    <!-- IMAGEN -->
    <!-- ===================================== -->
    <div class="main-container">

    
    
    <div class= "card mb-3" style="max-width: 850px text-end"> 
      <div class="row g-1" id="card-body">
        <div class="col-md-4"> 
          <img src="img/Imagen1.jpg" alt="Imagen1" width="300" height="auto">
        </div>
        <div class="col-md-8">
          <div class="card-body" >  
            <!-- ===============Grupo1====================== -->
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <h5 class="card-text">SAMSUNG Galaxy A32 128gb Blanco 4gb RAM</h5>
                <!-- <span class="$colors:(yellow);">Amazon's Choice</span> -->

                <!-- ===============Star====================== -->
            <!-- <svg width="16" height="16" fill="currentColor:" class="bi bi-star-fill" viewBox="0 0 16 16">
              <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
            </svg>
            <svg width="16" height="16" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16">
              <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
            </svg>
            <svg width="16" height="16" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16">
              <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
            </svg>
            <svg width="16" height="16" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16">
              <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
            </svg>
            <svg width="16" height="16" fill="currentColor" class="bi bi-star-half" viewBox="0 0 16 16"> 
              <path d="M5.354 5.119 7.538.792A.516.516 0 0 1 8 .5c.183 0 .366.097.465.292l2.184 4.327 4.898.696A.537.537 0 0 1 16 6.32a.548.548 0 0 1-.17.445l-3.523 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256a.52.52 0 0 1-.146.05c-.342.06-.668-.254-.6-.642l.83-4.73L.173 6.765a.55.55 0 0 1-.172-.403.58.58 0 0 1 .085-.302.513.513 0 0 1 .37-.245l4.898-.696zM8 12.027a.5.5 0 0 1 .232.056l3.686 1.894-.694-3.957a.565.565 0 0 1 .162-.505l2.907-2.77-4.052-.576a.525.525 0 0 1-.393-.288L8.001 2.223 8 2.226v9.8z"/>
            </svg> -->

             <p class="card-text">Visita la Store de SAMSUNG</p>
              <button type="button" class="btn btn-primary mb-1 fs-6 p-1">Agregar al Carrito</button>
             <p class="card-text"><small class="text-muted"> 60 calificaciones de "samsung a32"</small></p>

               </li>
                  <!-- ===============Grupo2====================== -->
                  <li class="list-group-item">
                    <span class="card-text">Precio recomendado: <del> $6,499.00 Detalles</del></span>
                    <p class="card-text"> Precio: <a href="#" class="link-danger">$5,397.00</a></p>
                    <span class="card-text">Ahorras: <a href="#" class="link-danger">$1,102.00 (17%)</a>	</span>
                    <p class="card-text"><small class="text-muted">Hasta 18 meses sin intereses de $299,89.</small></p>
                  </li>

                  
                  <!-- ===============Grupo3====================== -->
                    <li class="list-group-item">
                      <h6 class="card-text">Acerca de este artículo</h6>
                      <ul>
                        <li>Cuadruple cámara trasera: 64 MP (F1.8), 8 MP (F2.2), 5 MP (F2.4) + 5 MP (2.4) 
                        <li>Tamaño de pantalla: 6.4 inches; Sistema operativo: Android 10.0
                        <li>Cámara Frontal: 20 MP (F2.2)
                      </ul>
                      <a href="#" class="text-decoration-none">Comparar otras 4 opciones a partir de 
                        <a href="#" class="link-danger">$5,397.00</a>
                      </a>
                      <h6 class="card-text">Envío GRATIS.</h6>
                    </li>

                  <!-- ===============Grupo4====================== -->
                   <li class="list-group-item">
                    <div class="card mb-8" style="max-width: 0px;"></div>
                     <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item active" aria-current="page">Nuevo</li>
                             <li class="breadcrumb-item active" aria-current="page">2345 Vendidos</li>
                        </ol>
                      </nav>
                    <div>

                  </li>
              </ul>
           </div>
         </div>
       </div>
      </div>
    </div>

        <script>

          let carrito = [];

          const usuarioLocal = localStorage.getItem('usuario');

          const usuarioLogueado = JSON.parse(usuarioLocal);
          const nombreLogueado = localStorage.getItem('nombre');
          const nombre = document.querySelector('#nombre_logueado');
          const usuario = document.querySelector('#usuario_logueado');
          const contenidoCarrito = document.querySelector('#bodyCarrito');
          const btnAgregarCarrito = document.querySelector('#agregar-carrito');
          const btnCarrito = document.querySelector('#btnCarrito');
          const uiCarrito = document.querySelector('#carrito');
          const vaciarCarrito = document.querySelector('#vaciar-carrito');
          const botonesCarrito = document.querySelector('.botones-carrito');
          const menuUsuario = document.querySelector("#menu_usuario");
          const btnsAdministracion = document.querySelector("#administracion")
          console.log(usuarioLogueado);

          let cantidadProducto = 1;

          vaciarCarrito.addEventListener('click', (e) => {
            e.preventDefault();

            carrito = [];
            localStorage.removeItem('carrito');
            window.location.reload(); 
          })

          btnCarrito.addEventListener('mouseover', () =>{
            uiCarrito.style.display = 'block';
          });
          btnCarrito.addEventListener('mouseout', () =>{
            uiCarrito.style.display = 'none';
          });
          uiCarrito.addEventListener('mouseover', () =>{
            uiCarrito.style.display = 'block';
          });
          uiCarrito.addEventListener('mouseout', () =>{
            uiCarrito.style.display = 'none';
          });

          if(usuarioLocal){
            if( usuarioLogueado.rol != "ADMIN_ROLE"){
              btnsAdministracion.innerHTML = "";
            }
            usuario.addEventListener('mouseover', () =>{
            menuUsuario.style.display = 'block';
            });
            usuario.addEventListener('mouseout', () =>{
              menuUsuario.style.display = 'none';
            });
            menuUsuario.addEventListener('mouseover', () =>{
              menuUsuario.style.display = 'block';
            });
            menuUsuario.addEventListener('mouseout', () =>{
              menuUsuario.style.display = 'none';
            });
          } 

          if(usuarioLogueado != null) {
            usuario.innerHTML = `<a style="cursor: pointer"><i> Hola, ${ usuarioLogueado.nombre } </p><h5> Cuentas y Listas</h5></i></a>`;
            console.log("no es nulo");
          }else{
            usuario.innerHTML = '<a href="login.html"><i> Hola, Identificate </p><h5> Cuentas y Listas</h5></i></a>';
            console.log("si es nulo");
          }

          let carritoLocal = localStorage.getItem('carrito');
          console.log(carritoLocal);

          let strProductoCarrito = '';
          if(!carritoLocal){
            if(carrito.length === 0){
            let h3 = document.createElement('h3');
            h3.style.color = "black";
            strProductoCarrito = 'No hay productos en el carrito, empiece a agregar sus productos';
            h3.innerHTML = strProductoCarrito;
              
              contenidoCarrito.append(h3);
              botonesCarrito.style.display="none";
            }
          }
          

          if(carritoLocal){
            let carritoLocalJson = JSON.parse(carritoLocal);
            if(carritoLocalJson){
              carrito = carritoLocalJson;
            }

            botonesCarrito.style.display="flex";

            if(carrito.length === 0){
              
            }else{
              carritoLocalJson.forEach((producto) => {
              strProductoCarrito = '';
              strProductoCarrito += `<td><img src=http://143.244.157.68:8080/api/productos/imagen/${producto.id} style='width: 100px'></td>`;
              strProductoCarrito += '<td>' + producto.nombre.substr(0,15) + '...</td>';
              strProductoCarrito += '<td>' + producto.precio + '</td>';

              //strProductoCarrito += '<td style="display:flex"><button style="background-color:red;"> - </button> ' + producto.cantidad + ' <button style="background-color:green;" onclick="aumentarCantidad(\''+producto.id+'\')"> + </button></td>';
              strProductoCarrito += '<td>' + producto.cantidad + '</td>';
              strProductoCarrito += '<td>' + producto.total + '</td>';

              let row = document.createElement('tr');
              row.innerHTML = strProductoCarrito;
              contenidoCarrito.appendChild(row);
            });
            }
            
          
          }

          const aumentarCantidad = (id) => {
            
            carrito = carrito.map(productoCarrito => {
              if(productoCarrito.id == id){
                console.log(productoCarrito);
                productoCarrito.cantidad++;
                productoCarrito.total = productoCarrito.total * productoCarrito.cantidad;
                return productoCarrito;
              }else{
                return productoCarrito;
              }
            }); 

            if(carritoLocal){
            let carritoLocalJson = JSON.parse(carritoLocal);
              
              if(carritoLocalJson){
                carrito = carritoLocalJson;
              }
              

              botonesCarrito.style.display="flex";

              if(carrito.length === 0){
                
              }else{
                carritoLocalJson.forEach((producto) => {
                  strProductoCarrito = '';
                  strProductoCarrito += `<td><img src=http://localhost:8080/api/productos/imagen/${producto.id} style='width: 100px'></td>`;
                  strProductoCarrito += '<td>' + producto.nombre.substr(0,15) + '...</td>';
                  strProductoCarrito += '<td>' + producto.precio + '</td>';

                  strProductoCarrito += '<td style="display:flex"><button style="background-color:red;"> - </button> ' + producto.cantidad + ' <button style="background-color:green;" onclick="aumentarCantidad('+ producto.id +')"> + </button></td>';

                  let row = document.createElement('tr');
                  row.innerHTML = strProductoCarrito;
                  console.log(row);
                  contenidoCarrito.appendChild(row);
                });
              }
            
          
            } 
          }

          

          const agregarCarrito = () => {
            limpiarHTML();
            let strProductoCarrito = '';
            const productoCarrito = localStorage.getItem('producto');
            const productoCarritoJson = JSON.parse(productoCarrito);
            const existe = carrito.some( producto => producto.id === productoCarritoJson._id);
            const producto ={
                id:productoCarritoJson._id,
                nombre:productoCarritoJson.nombre,
                precio:productoCarritoJson.precio,
                cantidad:1,
                total: productoCarritoJson.precio
            }
            if(existe){
              carrito = carrito.map(productoCarrito => {
                if(productoCarrito.id === producto.id){
                    productoCarrito.cantidad++;
                
                    productoCarrito.total=productoCarrito.precio * productoCarrito.cantidad;
                    alert('Se modifico la cantidad del producto en el carrito!');
                    return productoCarrito; // retorna el objeto actualizado
                }else{
                    return productoCarrito; // retorna los objetos que no son los duplicados
                }
              });
            }else{
              
              carrito.push(producto);
              alert('Producto añadido al carrito!');
            }
            localStorage.setItem('carrito', JSON.stringify(carrito));
            let carritoLocal = localStorage.getItem('carrito');
            console.log(carritoLocal);

            let carritoLocalJson = JSON.parse(carritoLocal);
            console.log(carritoLocalJson);
            botonesCarrito.style.display="flex";

            
            
            carritoLocalJson.forEach((producto) => {
              strProductoCarrito = '';
              strProductoCarrito += `<td><img src=http://143.244.157.68:8080/api/productos/imagen/${producto.id} style='width: 100px'></td>`;
              strProductoCarrito += '<td>' + producto.nombre.substr(0,15) + '...</td>';
              strProductoCarrito += '<td>' + producto.precio + '</td>';
              strProductoCarrito += '<td style="display:flex">' + producto.cantidad + '</td>';
              strProductoCarrito += '<td>' + producto.total + '</td>';

              let row = document.createElement('tr');
              row.innerHTML = strProductoCarrito;
              contenidoCarrito.appendChild(row);
            })
          }

          // Funciones reutilizables
          const actualizarListaCarrito = (listaCarrito) => {
            listaCarrito.forEach((producto) => {
              strProductoCarrito = '';
              strProductoCarrito += `<td><img src=http://143.244.157.68:8080/api/productos/imagen/${producto.id} style='width: 100px'></td>`;
              strProductoCarrito += '<td>' + producto.nombre.substr(0,15) + '...</td>';
              strProductoCarrito += '<td>' + producto.precio + '</td>';

              strProductoCarrito += '<td style="display:flex"><button style="background-color:red;"> - </button> ' + producto.cantidad + ' <button style="background-color:green;" onclick="aumentarCantidad(\''+producto.id+'\')"> + </button></td>';

              let row = document.createElement('tr');
              row.innerHTML = strProductoCarrito;
              contenidoCarrito.appendChild(row);
            });
          }

          
          
          const cerrarSesion = () => {
            localStorage.removeItem('nombre');
            location.href ="http://talleramzfic.ddns.net/";
          }

          var requestOptions = {
            method: 'GET',
            redirect: 'follow'
          };

          const subMenu = document.querySelector('#submenu');
          let strMenu = '';

          fetch("http://143.244.157.68:8080/api/categorias", requestOptions)
            .then(response => response.text())
            .then(result => {
              resultJson = JSON.parse(result);


              resultJson.categorias.forEach( (categoria) => {
                strMenu += `<li onclick=guardarCategoria('${ categoria._id }')><a href="productos.html">${ categoria.nombre }<a/></li>`;

                subMenu.innerHTML = strMenu;
              });



              

              
              

            })
            .catch(error => console.log('error', error));

            const guardarCategoria = (id) => {
              localStorage.setItem('idCategoria', id.toString());
              //location.href ="file:///C:/Users/Admin/Desktop/Proyectos%20Web/amazon/equipo4-3-amazon/front-amazon/productos.html";
            }


            var requestOptions = {
                method: 'GET',
                redirect: 'follow'
            };

            const productoUl = document.querySelector('#card-body');

            let strProducto = "";

            const idProducto = localStorage.getItem('idProducto');

            fetch("http://143.244.157.68:8080/api/productos/"+ idProducto +"", requestOptions)
            .then(response => response.text())
            .then(result => {
                
                const resultJson = JSON.parse(result);
                localStorage.setItem('producto', JSON.stringify(resultJson.producto));
                console.log(resultJson.producto.nombre);
                const { _id, nombre, precio, descripcion, stock } = resultJson.producto;

                strProducto += `<div class="col-md-4"> 
          <img src="http://143.244.157.68:8080/api/productos/imagen/${ _id }" alt="Imagen1" width="300" height="auto">
        </div>
        <div class="col-md-8">
          <div class="card-body" >  
            <!-- ===============Grupo1====================== -->
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <h5 class="card-text">${ nombre }</h5>
                

             <p class="card-text">Visita la Store del Vendedor</p>
              <button type="button" class="btn btn-primary mb-1 fs-6 p-1" onclick="agregarCarrito()">Agregar al Carrito</button>
             <p class="card-text"><small class="text-muted"> 60 calificaciones de "samsung a32"</small></p>

               </li>
                  <!-- ===============Grupo2====================== -->
                  <li class="list-group-item">
                    <span class="card-text">Precio recomendado: <del> $6,499.00 Detalles</del></span>
                    <p class="card-text"> Precio: <a href="#" class="link-danger">$${ precio }</a></p>
                    <span class="card-text">Ahorras: <a href="#" class="link-danger">$1,102.00 (17%)</a>	</span>
                    <p class="card-text"><small class="text-muted">Hasta 18 meses sin intereses de $299,89.</small></p>
                  </li>

                  
                  <!-- ===============Grupo3====================== -->
                    <li class="list-group-item">
                      <h6 class="card-text">Acerca de este artículo</h6>
                      <ul>
                        <li>${ descripcion }
                      </ul>
                      <a href="#" class="text-decoration-none">Comparar otras 4 opciones a partir de 
                        <a href="#" class="link-danger">$5,397.00</a>
                      </a>
                      <h6 class="card-text">Envío GRATIS.</h6>
                    </li>

                  <!-- ===============Grupo4====================== -->
                   <li class="list-group-item">
                    <div class="card mb-8" style="max-width: 0px;"></div>
                     <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item active" aria-current="page">Stock</li>
                             <li class="breadcrumb-item active" aria-current="page">${ stock }</li>
                        </ol>
                      </nav>
                    <div>

                  </li>
              </ul>
           </div>
         </div>
       </div>`;

                productoUl.innerHTML = strProducto;
                
            })
            .catch(error => console.log('error', error));


            function limpiarHTML() {
                // Forma lenta
                // contenedorCarrito.innerHTML = '';


                while(contenidoCarrito.firstChild) {
                    contenidoCarrito.removeChild(contenidoCarrito.firstChild)
                }
            }

        </script>

     </body>
</html>